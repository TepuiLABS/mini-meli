# mini-meli

[![Latest Version on Packagist](https://img.shields.io/packagist/v/tepuilabs/mini-meli.svg?style=flat-square)](https://packagist.org/packages/tepuilabs/mini-meli)
[![Total Downloads](https://img.shields.io/packagist/dt/tepuilabs/mini-meli.svg?style=flat-square)](https://packagist.org/packages/tepuilabs/mini-meli)
[![PHP Version](https://img.shields.io/packagist/php-v/tepuilabs/mini-meli.svg?style=flat-square)](https://packagist.org/packages/tepuilabs/mini-meli)

<p align="center">
	<img src="carbon_new.png" width="1028">
</p>

Librer√≠a completa para Mercado Libre con OAuth 2.0 PKCE, refresh tokens y gesti√≥n de aplicaciones. Implementa todas las mejores pr√°cticas de seguridad y funcionalidades de la API oficial.

## üöÄ Caracter√≠sticas

- ‚úÖ **OAuth 2.0 PKCE** - Autenticaci√≥n segura con Proof Key for Code Exchange
- ‚úÖ **Refresh Tokens** - Renovaci√≥n autom√°tica de tokens con offline_access
- ‚úÖ **Multi-Site Support** - Soporte para todos los sitios de Mercado Libre
- ‚úÖ **App Management** - Gesti√≥n completa de aplicaciones y permisos
- ‚úÖ **Security First** - Validaci√≥n robusta y protecci√≥n CSRF
- ‚úÖ **PHP 8.3+** - Aprovecha las √∫ltimas funcionalidades del lenguaje
- ‚úÖ **Type Safety** - Tipado estricto y union types
- ‚úÖ **Readonly Properties** - Inmutabilidad donde sea apropiado
- ‚úÖ **Match Expressions** - L√≥gica m√°s clara y eficiente
- ‚úÖ **Named Arguments** - Mejor legibilidad del c√≥digo
- ‚úÖ **First-class Callable Syntax** - Sintaxis moderna para callbacks
- ‚úÖ **Improved Error Handling** - Manejo de errores m√°s espec√≠fico
- ‚úÖ **Backward Compatibility** - Compatible con versiones anteriores

## üì¶ Instalaci√≥n

```bash
composer require tepuilabs/mini-meli
```

## ‚öôÔ∏è Configuraci√≥n

### Variables de Entorno

Agrega en tu archivo de configuraci√≥n:

```env
GRANT_TYPE=authorization_code
CLIENT_ID=tu_client_id
CLIENT_SECRET=tu_client_secret
REDIRECT_URL=http://localhost:9000
SCOPES=read write offline_access
```

> [!NOTE]
> Estos datos los debes configurar en Mercado Libre cuando crees una aplicaci√≥n. Solo necesitas el client_id y client_secret.

## üîê Uso

### 1. Autenticaci√≥n OAuth 2.0 PKCE

```php
<?php

use Tepuilabs\MeliServices\MeliConfig;
use Tepuilabs\MeliServices\MeliServices;
use Tepuilabs\MeliServices\MeliScopes;

require 'vendor/autoload.php';

// Generar PKCE y state
$pkce = MeliConfig::generatePkce();
$state = MeliConfig::generateState();

// Crear configuraci√≥n
$config = MeliConfig::forAuthorization(
    clientId: 'tu_client_id',
    clientSecret: 'tu_client_secret',
    redirectUri: 'http://localhost:9000',
    codeVerifier: $pkce['code_verifier'],
    codeChallenge: $pkce['code_challenge'],
    state: $state,
    scopes: MeliScopes::getOfflineAccess() // Incluye refresh tokens
);

$meli = new MeliServices($config);

// Generar URL de autorizaci√≥n
$authUrl = $meli->getAuthorizationUrl('MLA'); // Argentina
echo "Ve a: {$authUrl}";
```

### 2. Intercambio de C√≥digo por Token

```php
// En tu callback
$code = $_GET['code'] ?? '';
$state = $_GET['state'] ?? '';

// Verificar state para seguridad
if ($state !== $savedState) {
    throw new Exception("State no coincide");
}

$config = new MeliConfig(
    clientId: 'tu_client_id',
    clientSecret: 'tu_client_secret',
    code: $code,
    redirectUri: 'http://localhost:9000',
    codeVerifier: $savedCodeVerifier // De la sesi√≥n
);

$meli = new MeliServices($config);
$response = $meli->generateAccessToken();

// Guardar tokens
$accessToken = $response->getAccessToken();
$refreshToken = $response->getRefreshToken();
$userId = $response->getUserId();
```

### 3. Refresh Tokens

```php
// Renovar token cuando expire
$response = $meli->refreshAccessToken($refreshToken);

// Actualizar tokens
$newAccessToken = $response->getAccessToken();
$newRefreshToken = $response->getRefreshToken(); // Siempre nuevo
```

### 4. Llamadas a la API

```php
// Crear instancia para API calls
$config = MeliConfig::forAuthorization(
    clientId: 'tu_client_id',
    clientSecret: 'tu_client_secret',
    redirectUri: 'http://localhost:9000'
);
$meli = new MeliServices($config);

// Hacer llamadas
$userProfile = $meli->get('/users/me', $accessToken);
$userItems = $meli->get("/users/{$userId}/items/search", $accessToken);
$categories = $meli->get('/sites/MLA/categories', $accessToken);
```

### 5. Gesti√≥n de Aplicaciones

```php
// Obtener detalles de la aplicaci√≥n
$appDetails = $meli->getApplicationDetails($accessToken, $appId);

// Obtener aplicaciones autorizadas por el usuario
$userApps = $meli->getUserApplications($accessToken, $userId);

// Obtener usuarios que dieron permisos a tu app
$appGrants = $meli->getApplicationGrants($accessToken, $appId);

// Revocar autorizaci√≥n de un usuario
$result = $meli->revokeUserAuthorization($accessToken, $userId, $appId);
```

## üåç Sitios Soportados

La librer√≠a soporta todos los sitios de Mercado Libre:

```php
use Tepuilabs\MeliServices\MeliSites;

// Sitios disponibles
MeliSites::MLA; // Argentina
MeliSites::MLB; // Brasil
MeliSites::MLM; // M√©xico
MeliSites::MLC; // Chile
MeliSites::MCO; // Colombia
MeliSites::MPE; // Per√∫
MeliSites::MLU; // Uruguay
MeliSites::MLV; // Venezuela

// Obtener informaci√≥n del sitio
$siteInfo = MeliSites::getSite('MLA');
$domain = MeliSites::getDomain('MLA');
$name = MeliSites::getName('MLA');
$flag = MeliSites::getFlag('MLA');
```

## üîë Scopes y Permisos

```php
use Tepuilabs\MeliServices\MeliScopes;

// Scopes disponibles
MeliScopes::READ;           // Solo lectura
MeliScopes::WRITE;          // Lectura y escritura
MeliScopes::OFFLINE_ACCESS; // Incluye refresh tokens

// Obtener scopes predefinidos
$defaultScopes = MeliScopes::getDefault();        // read write
$offlineScopes = MeliScopes::getOfflineAccess();  // read write offline_access

// Validar scopes
$isValid = MeliScopes::isValid('read');
$hasOffline = MeliScopes::hasOfflineAccess($scopes);
$hasRead = MeliScopes::hasRead($scopes);
$hasWrite = MeliScopes::hasWrite($scopes);
```

## üõ°Ô∏è Seguridad

### PKCE (Proof Key for Code Exchange)

La librer√≠a implementa PKCE para prevenir ataques de interceptaci√≥n de c√≥digo:

```php
// Generaci√≥n autom√°tica
$pkce = MeliConfig::generatePkce();
// code_verifier: string aleatorio de 32 bytes
// code_challenge: hash SHA-256 del verifier, base64url encoded
```

### State Protection

Protecci√≥n CSRF con par√°metros state aleatorios:

```php
$state = MeliConfig::generateState(); // 16 bytes aleatorios
```

### Validaci√≥n Robusta

```php
// Validaci√≥n autom√°tica de par√°metros
$config = new MeliConfig(
    clientId: $clientId,
    clientSecret: $clientSecret,
    code: $code,
    redirectUri: $redirectUri,
    codeVerifier: $codeVerifier
);

if (!$config->isValid()) {
    throw new Exception("Configuraci√≥n inv√°lida");
}
```

## üìö API Reference

### MeliServices

#### M√©todos Est√°ticos

- `fromArray(array $params): self` - Crear desde array
- `fromEnvironment(): self` - Crear desde variables de entorno

#### M√©todos de Instancia

- `generateAccessToken(): MeliResponse` - Generar token
- `refreshAccessToken(string $refreshToken): MeliResponse` - Renovar token
- `getAuthorizationUrl(string $site, array $params = []): string` - Generar URL de autorizaci√≥n
- `get(string $endpoint, string $accessToken): array` - GET request
- `post(string $endpoint, string $accessToken, array $data = []): array` - POST request
- `put(string $endpoint, string $accessToken, array $data = []): array` - PUT request
- `delete(string $endpoint, string $accessToken): array` - DELETE request
- `getApplicationDetails(string $accessToken, string $appId): array` - Detalles de app
- `getUserApplications(string $accessToken, string $userId): array` - Apps del usuario
- `getApplicationGrants(string $accessToken, string $appId): array` - Usuarios conectados
- `revokeUserAuthorization(string $accessToken, string $userId, string $appId): array` - Revocar autorizaci√≥n

### MeliConfig

#### M√©todos Est√°ticos

- `fromArray(array $params): self` - Crear desde array
- `fromEnvironment(): self` - Crear desde variables de entorno
- `forAuthorization(...): self` - Crear para URLs de autorizaci√≥n
- `generatePkce(): array` - Generar PKCE
- `generateState(): string` - Generar state

#### M√©todos de Instancia

- `toArray(): array` - Convertir a array
- `isValid(): bool` - Verificar si es v√°lido
- `hasPkce(): bool` - Verificar si tiene PKCE
- `hasState(): bool` - Verificar si tiene state
- `hasRefreshToken(): bool` - Verificar si tiene refresh token
- `isForTokenExchange(): bool` - Verificar si es para intercambio
- `getScopesString(): string` - Obtener scopes como string
- `hasOfflineAccess(): bool` - Verificar offline access
- `hasReadPermission(): bool` - Verificar permiso de lectura
- `hasWritePermission(): bool` - Verificar permiso de escritura

### MeliResponse

#### Propiedades

- `data: array` - Datos de la respuesta
- `statusCode: int` - C√≥digo de estado HTTP

#### M√©todos

- `getAccessToken(): ?string` - Obtener access token
- `getRefreshToken(): ?string` - Obtener refresh token
- `getTokenType(): ?string` - Obtener tipo de token
- `getExpiresIn(): ?int` - Obtener tiempo de expiraci√≥n
- `getScope(): ?string` - Obtener scope
- `getUserId(): ?int` - Obtener ID de usuario
- `hasAccessToken(): bool` - Verificar si tiene access token
- `hasRefreshToken(): bool` - Verificar si tiene refresh token
- `toArray(): array` - Convertir a array
- `toJson(): string` - Convertir a JSON
- `isSuccessful(): bool` - Verificar si la respuesta es exitosa
- `getErrorMessage(): ?string` - Obtener mensaje de error
- `getErrorDescription(): ?string` - Obtener descripci√≥n del error

### MeliScopes

#### Constantes

- `READ` - Permiso de lectura
- `WRITE` - Permiso de escritura
- `OFFLINE_ACCESS` - Permiso offline (refresh tokens)

#### M√©todos Est√°ticos

- `getAll(): array` - Obtener todos los scopes
- `getDefault(): array` - Obtener scopes por defecto
- `getOfflineAccess(): array` - Obtener scopes con offline access
- `isValid(string $scope): bool` - Validar scope
- `validateScopes(array $scopes): bool` - Validar m√∫ltiples scopes
- `toString(array $scopes): string` - Convertir a string
- `toArray(string $scopes): array` - Convertir a array
- `hasOfflineAccess(array|string $scopes): bool` - Verificar offline access
- `hasRead(array|string $scopes): bool` - Verificar lectura
- `hasWrite(array|string $scopes): bool` - Verificar escritura

### MeliSites

#### Constantes

- `MLA` - Argentina
- `MLB` - Brasil
- `MLM` - M√©xico
- `MLC` - Chile
- `MCO` - Colombia
- `MPE` - Per√∫
- `MLU` - Uruguay
- `MLV` - Venezuela

#### M√©todos Est√°ticos

- `getAll(): array` - Obtener todos los sitios
- `getSite(string $siteId): ?array` - Obtener informaci√≥n del sitio
- `getDomain(string $siteId): string` - Obtener dominio
- `getName(string $siteId): string` - Obtener nombre
- `getFlag(string $siteId): string` - Obtener bandera
- `isValid(string $siteId): bool` - Validar sitio
- `getAuthorizationUrl(string $siteId): string` - Obtener URL de autorizaci√≥n
- `getApiUrl(): string` - Obtener URL base de la API
- `getOAuthTokenEndpoint(): string` - Obtener endpoint de tokens

## üö® Manejo de Errores

La librer√≠a incluye manejo de errores espec√≠fico:

```php
try {
    $response = $meli->generateAccessToken();
} catch (GenericException $e) {
    echo "Error: " . $e->getMessage();
    echo "C√≥digo: " . $e->getCode();
}
```

### Tipos de Error

- **400** - Solicitud inv√°lida
- **401** - Credenciales inv√°lidas
- **403** - Acceso denegado
- **404** - Endpoint no encontrado
- **429** - Demasiadas solicitudes
- **5xx** - Error del servidor

### Errores Espec√≠ficos de OAuth

- **invalid_client** - Client ID o Secret inv√°lidos
- **invalid_grant** - C√≥digo o refresh token inv√°lido/expirado
- **invalid_scope** - Scope inv√°lido
- **invalid_request** - Par√°metros faltantes o inv√°lidos
- **unsupported_grant_type** - Grant type no soportado
- **forbidden** - Acceso denegado
- **local_rate_limited** - Demasiadas solicitudes
- **unauthorized_client** - Cliente no autorizado
- **unauthorized_application** - Aplicaci√≥n bloqueada

## üß™ Testing

```bash
# Ejecutar tests
composer test

# Ejecutar tests con coverage
composer test-coverage

# Formatear c√≥digo
composer format
```

## üìù Ejemplo Completo

```php
<?php

use Tepuilabs\MeliServices\Exceptions\GenericException;
use Tepuilabs\MeliServices\MeliConfig;
use Tepuilabs\MeliServices\MeliServices;
use Tepuilabs\MeliServices\MeliScopes;

require 'vendor/autoload.php';

session_start();

// Configuraci√≥n
$clientId = 'tu_client_id';
$clientSecret = 'tu_client_secret';
$redirectUri = 'http://localhost:9000';

// Paso 1: Generar URL de autorizaci√≥n
if (!isset($_GET['code'])) {
    $pkce = MeliConfig::generatePkce();
    $state = MeliConfig::generateState();

    $_SESSION['code_verifier'] = $pkce['code_verifier'];
    $_SESSION['state'] = $state;

    $config = MeliConfig::forAuthorization(
        clientId: $clientId,
        clientSecret: $clientSecret,
        redirectUri: $redirectUri,
        codeVerifier: $pkce['code_verifier'],
        codeChallenge: $pkce['code_challenge'],
        state: $state,
        scopes: MeliScopes::getOfflineAccess()
    );

    $meli = new MeliServices($config);
    $authUrl = $meli->getAuthorizationUrl('MLA');

    echo "Ve a: {$authUrl}";
    exit;
}

// Paso 2: Intercambiar c√≥digo por token
try {
    $code = $_GET['code'];
    $state = $_GET['state'];

    // Verificar state
    if ($state !== $_SESSION['state']) {
        throw new Exception("State no coincide");
    }

    $config = new MeliConfig(
        clientId: $clientId,
        clientSecret: $clientSecret,
        code: $code,
        redirectUri: $redirectUri,
        codeVerifier: $_SESSION['code_verifier']
    );

    $meli = new MeliServices($config);
    $response = $meli->generateAccessToken();

    // Guardar tokens
    $_SESSION['access_token'] = $response->getAccessToken();
    $_SESSION['refresh_token'] = $response->getRefreshToken();
    $_SESSION['user_id'] = $response->getUserId();

    echo "¬°Autenticaci√≥n exitosa!";

} catch (GenericException $e) {
    echo "Error: " . $e->getMessage();
}
```

## ü§ù Contribuir

1. Fork el proyecto
2. Crea una rama para tu feature (`git checkout -b feature/AmazingFeature`)
3. Commit tus cambios (`git commit -m 'Add some AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abre un Pull Request

## üìÑ Licencia

Este proyecto est√° bajo la Licencia MIT. Ver el archivo [LICENSE.md](LICENSE.md) para m√°s detalles.

## üîó Enlaces √ötiles

- [Documentaci√≥n oficial de Mercado Libre](https://developers.mercadolibre.com.ar/es_ar/autenticacion-y-autorizacion)
- [Recomendaciones de seguridad](https://developers.mercadolibre.com.ar/es_ar/recomendaciones-de-autorizacion-y-token)
- [Gesti√≥n de aplicaciones](https://developers.mercadolibre.com.ar/es_ar/gestiona-tus-aplicaciones)
